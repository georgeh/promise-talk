<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/league.css">
    <link rel="stylesheet" href="lib/css/zenburn.css">
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h1>Promises - Escape From Callback Hell</h1>
                <p>George Hotelling - Progressive Leasing</p>
            </section>
            <section><img src="img/adam.png" alt="Adam"></section>
            <section><img src="img/spotify.png" alt="Spotify"></section>
            <section><img src="img/r-newmusicfriday.png" alt="/r/NewMusicFriday"></section>
            <section>
                <h2>New Music Friday Bot</h2>
                <ul>
                    <li>Load New Music Friday Playlist</li>
                    <li>Post Playlist</li>
                    <li>Sticky Playlist</li>
                    <li>Post Tracks</li>
                    <li>Announce Success</li>
                </ul>
            </section>
            <section>
                <h2>Callbacks</h2>
                <pre><code>spotifyApi.clientCredentialsGrant(function(err, credentials) {
    if (err) return err;

    spotifyApi.setAccessToken(credentials.body['access_token']);
    return spotifyApi.getPlaylist('spotify', 'NewMusicFriday', function postPlaylist(err, spotifyRes) {
        if (err) return err;

        return reddit('/api/submit').post({
                'api_type': 'json',
                'kind': 'link',
                'resubmit': true, 
                'sendreplies': false,
                'sr': config.reddit.subreddit,
                'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
                'url': _.get(spotifyRes, 'body.external_urls.spotify')
            }, function(err, redditPostRes) {
                if (err) return err;
                
                return reddit('/api/set_subreddit_sticky').post({
                        id: redditPostRes.json.data.name,
                        num: 1,
                        state: true
                    }, function(err) {
                        if (err) return err;
                        
                        var trackPosted = [].fill(false, 0, spotifyRes.body.tracks.items.length - 1);
                        
                        for (var i=0; i < spotifyRes.body.tracks.items.length; i++) {
                            var item = spotifyRes.body.tracks.items[i];
                            var artists = item.track.artists.map(function (a) { return a.name; }).join(', ');
                            var title = artists + ' - ' + item.track.name;

                            reddit('/api/comment').post({
                                    'api_type': 'json',
                                    'text': '[' + title + '](' + _.get(item, 'track.external_urls.spotify') + ')',
                                    'thing_id': spotifyRes.reddit.json.data.name
                            }, function(err) {
                                if (err) return err;
                                console.log('Posted ' + title);
                                trackPosted[i] = true;
                                if (trackPosted.every((trackDone) => trackDone)) {
                                    console.log('DONE!');
                                }
                            });
                        }
                    });
            });
    });
});
                </code></pre>
                <aside class="notes">This code is for illustration purposes only and probably wouldn't work even if you could find an API that
                    supported callbacks.</aside>
            </section>
            <section>
                <h2>OK, Better Callbacks</h2><pre><code>spotifyApi.clientCredentialsGrant(function (err, credentials) {
    if (err) return err;

    spotifyApi.setAccessToken(credentials.body['access_token']);
    return spotifyApi.getPlaylist('spotify', 'NewMusicFriday', postPlaylist);
});

var spotifyRes;

function postPlaylist(err, spotifyResArg) {
    if (err) return err;

    spotifyRes = spotifyResArg;

    return reddit('/api/submit').post({
        'api_type': 'json',
        'kind': 'link',
        'resubmit': true,
        'sendreplies': false,
        'sr': config.reddit.subreddit,
        'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
        'url': _.get(spotifyRes, 'body.external_urls.spotify')
    }, stickyPlaylist);
}

function stickyPlaylist(err, redditPostRes) {
    if (err) return err;

    return reddit('/api/set_subreddit_sticky').post({
        id: redditPostRes.json.data.name,
        num: 1,
        state: true
    }, postTracks);
}

var trackPosted;
function postTracks(err) {
    if (err) return err;

    trackPosted = [].fill(false, 0, spotifyRes.body.tracks.items.length - 1);

    for (var i = 0; i < spotifyRes.body.tracks.items.length; i++) {
        var item = spotifyRes.body.tracks.items[i];
        var artists = item.track.artists.map(function (a) { return a.name; }).join(', ');
        var title = artists + ' - ' + item.track.name;

        reddit('/api/comment').post({
            'api_type': 'json',
            'text': '[' + title + '](' + _.get(item, 'track.external_urls.spotify') + ')',
            'thing_id': spotifyRes.reddit.json.data.name
        }, onTrackPosted(title, i));
    }
}

function onTrackPosted(title, i) {
    return function (err) {
        if (err) return err;
        console.log('Posted ' + title);
        trackPosted[i] = true;
        if (trackPosted.every((trackDone) => trackDone)) {
            console.log('DONE!');
        }
    }
}
                </code></pre>
                <aside class="notes">This code is for illustration purposes only and probably wouldn't work even if you could find an API that
                    supported callbacks.</aside>
            </section>
            <section>
                <h2>Promises!</h2>
            </section>
            <section>
                <h2>Promises</h2>

                <p>What is a Promise?</p>

                <p>Depends on who you ask.</p>
            </section>
            <section>
                <h2>Promises</h2>
                <h3><a href="https://promisesaplus.com/">Promises/A+ Spec</a></h3>
                <blockquote>“promise” is an object or function with a then method whose behavior conforms to this specification.</blockquote>
            </section>

            <section>
                <h2>Promises</h2>
                <h3><a href="http://www.ecma-international.org/ecma-262/6.0/">ECMAScript® 2015 Language Specification</a></h3>
                <blockquote>
                    <p>Promise instances are ordinary objects that inherit properties from the Promise prototype object (the
                        intrinsic, %PromisePrototype%). Promise instances are initially created with the internal slots described
                        in <a href="#table-59">Table
      59</a>.</p>
                    <figure>
                        <figcaption><span id="table-59">Table 59</span> — Internal Slots of Promise Instances</figcaption>
                        <table class="real-table">
                            <tbody>
                                <tr>
                                    <th>Internal Slot</th>
                                    <th>Description</th>
                                </tr>
                                <tr>
                                    <td>[[PromiseState]]</td>
                                    <td>A String value that governs how a promise will react to incoming calls to its <code>then</code>                                        method. The possible values are: <code>"pending"</code><span style="font-family: Times New Roman">,</span>                                        <code>"fulfilled"</code>, and <code>"rejected"</code><span style="font-family: Times New Roman">.</span></td>
                                </tr>
                                <tr>
                                    <td>[[PromiseResult]]</td>
                                    <td>The value with which the promise has been fulfilled or rejected, if any. Only meaningful
                                        if <span style="font-family: Times New Roman">[[PromiseState]]</span> is not <code>"pending"</code>.</td>
                                </tr>
                                <tr>
                                    <td>[[PromiseFulfillReactions]]</td>
                                    <td>A <a href="#sec-list-and-record-specification-type">List</a> of PromiseReaction records
                                        to be processed when/if the promise transitions from the <code>"pending"</code> state
                                        to the <code>"fulfilled"</code> state.</td>
                                </tr>
                                <tr>
                                    <td>[[PromiseRejectReactions]]</td>
                                    <td>A <a href="#sec-list-and-record-specification-type">List</a> of PromiseReaction records
                                        to be processed when/if the promise transitions from the <code>"pending"</code> state
                                        to the <code>"rejected"</code> state.</td>
                                </tr>
                            </tbody>
                        </table>
                    </figure>
                </blockquote>
            </section>
            <section>
                <h2>Promises</h2>
                <p>TODO: Duck picture</p>
                <p>basically anything with a <code>.then()</code> method</p>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Load New Music Friday Playlist</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(function(data) {
    spotifyApi.setAccessToken(data.body['access_token']);
    spotifyApi.getPlaylist('spotify', 'NewMusicFriday');
  })</code></pre>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Post Playlist</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(function(data) {
    spotifyApi.setAccessToken(data.body['access_token']);
    spotifyApi.getPlaylist('spotify', 'NewMusicFriday')
        .then(function(playlist) {
            reddit('/api/submit').post({
                'api_type': 'json',
                'kind': 'link',
                'resubmit': true,
                'sendreplies': false,
                'sr': 'NewMusicFriday',
                'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
                'url': _.get(spotifyRes, 'body.external_urls.spotify')
            }))
        })
  })</code></pre>
                <aside class="notes">You can see the Pyramid of Doom growing</aside>
            </section>
            <section>
                <h2>Promise Anti-Pattern #1</h2>
                <p>Calling <code>.then()</code> Inside a <code>.then()</code></p>
            </section>
            <section>
                <h2><code>.then()</code> Rule #1</h2>
                <p>If you return a Promise from a <code>.then()</code> the outer Promise becomes the inner Promise</p>
                <aside class="notes">That means that the chain will become unresolved and will wait to call <code>.then()</code></aside>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Load New Music Friday Playlist</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(function(data) {
    spotifyApi.setAccessToken(data.body['access_token']);
    return spotifyApi.getPlaylist('spotify', 'NewMusicFriday');
  })
  .then(function(playlist) {
    reddit('/api/submit').post({
        'api_type': 'json',
        'kind': 'link',
        'resubmit': true,
        'sendreplies': false,
        'sr': 'NewMusicFriday',
        'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
        'url': _.get(spotifyRes, 'body.external_urls.spotify')
    })
  })</code></pre>
            </section>
            <section>
                <h2><code>.then()</code> Rule #2</h2>
                <p>If you return nothing from a <code>.then()</code>, the Promise value stays the same.</p>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Refactor!</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  
function saveAccessToken(data) {
  spotifyApi.setAccessToken(data.body['access_token']);
}

function getPlaylist() {
    return spotifyApi.getPlaylist('spotify', 'NewMusicFriday');
}

function postPlaylist(playlist) {
  return reddit('/api/submit').post({
    'api_type': 'json',
    'kind': 'link',
    'resubmit': true,
    'sendreplies': false,
    'sr': 'NewMusicFriday',
    'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
    'url': _.get(spotifyRes, 'body.external_urls.spotify')
  });
}</code></pre>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Sticky Playlist</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  .then(stickyPlaylist)
…
function stickyPlaylist(redditPostRes) {
  return reddit('/api/set_subreddit_sticky').post({
    id: redditPostRes.json.data.name,
    num: 1,
    state: true
  });
}</code></pre>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Post Tracks</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  .then(stickyPlaylist)
  .then(postTracks)
…
function postTracks(???) {

}</code></pre>
<aside class="notes">We need the result of getPlaylist() and postPlaylist()!</aside>
            </section>
            <section>
                <h2>Promise.all()</h2>
                <aside class="notes">
                    <ul>
                        <li>Takes an array of Promise and non-Promise values</li>
                        <li>Waits for them all to be resolved</li>
                        <li>Calls <code>.then()</code> with all resolved values</li>
                    </ul>
                </aside>
            </section>
            <section>
                <h2>Refactor!</h2>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  .then(stickyPlaylist)
…
function postPlaylist(playlist) {
  return Promise.all([playlist, reddit('/api/submit').post({
    'api_type': 'json',
    'kind': 'link',
    'resubmit': true,
    'sendreplies': false,
    'sr': 'NewMusicFriday',
    'title': _.get(spotifyRes, 'body.name') + ' - ' + moment().format('MMMM Do, YYYY'),
    'url': _.get(spotifyRes, 'body.external_urls.spotify')
  })]);
}

function stickyPlaylist(playlist, redditPost) {
  return Promise.all([playlist, redditPost, reddit('/api/set_subreddit_sticky').post({
    id: redditPost.json.data.name,
    num: 1,
    state: true
  })]);
}
</code></pre>
                <aside class="notes">We are now using <code>Promise.all()</code> to collect the results we need</aside>
            </section>
            <section>
                <h2>New Music Friday Bot</h2>
                <h3>Post Tracks</h3>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  .then(stickyPlaylist)
  .then(postTracks)
…
function postTracks(playlist, redditPost) {
    return Promise.all(playlist.body.tracks.items.map(function(item) {
        var artists = item.track.artists.map(function (a) { return a.name; }).join(', ');
        var title = artists + ' - ' + item.track.name;

        return reddit('/api/comment').post({
                'api_type': 'json',
                'text': '[' + title + '](' + _.get(item, 'track.external_urls.spotify') + ')',
                'thing_id': redditPost.json.data.name
            })
            .then(console.log.bind(console, 'Posted ' + title));
    }));
}</code></pre>
                <aside class="notes">
                    Remember Anti-Pattern #1 - calling a <code>.then()</code> from inside <code>.then()</code>?
                    Not applicable here because <i>waves hands and trails off</i><br>
                    Real reason - we could attach another method after <code>postTracks()</code>, or can consider the Track -> Promise map to be its own Promise chain.
                </aside>
            </section>
            <section>
                <h2>Error Handling</h2>
                <pre><code>spotifyApi.clientCredentialsGrant(function (err, credentials) {
    if (err) return err;
    …
});
function postPlaylist(err, spotifyResArg) {
    if (err) return err;
…
}

function stickyPlaylist(err, redditPostRes) {
    if (err) return err;
…
}

function postTracks(err) {
    if (err) return err;
…
}

function onTrackPosted(title, i) {
    return function (err) {
        if (err) return err;
…
        }
    }
}</code></pre>
            </section>
            <section>
                <h2>Error Handling</h2>
                <pre><code>spotifyApi.clientCredentialsGrant()
  .then(saveAccessToken)
  .then(getPlaylist)
  .then(postPlaylist)
  .then(stickyPlaylist)
  .then(postTracks)
  .catch(console.error.bind(console, arguments))</code></pre>
            </section>
        </div>
    </div>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    <script>
        Reveal.initialize({
                slideNumber: 'c/t',
                
                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });
    </script>
</body>

</html>